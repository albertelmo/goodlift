# 상담기록 동영상 첨부 기능 설계

## 1. 개요

상담기록 추가/수정 시 동영상을 첨부할 수 있고, 공개 조회 페이지에서도 동영상을 볼 수 있도록 구현합니다.

---

## 2. 기술 스택 및 인프라

### 2.1 현재 시스템 분석
- ✅ **파일 업로드**: `multer` 사용 중 (식단 이미지 업로드)
- ✅ **저장소**: 로컬 파일 시스템 (`/uploads` 디렉토리)
- ✅ **정적 파일 서빙**: Express static middleware (`/uploads` 경로)
- ✅ **이미지 처리**: `sharp` 라이브러리 (썸네일 생성)

### 2.2 동영상 저장 방식 선택

#### 옵션 1: 로컬 파일 시스템 (현재 방식과 동일) ⭐ **추천**
**장점:**
- 기존 인프라 재사용 가능
- 추가 비용 없음
- 구현이 간단함

**단점:**
- 서버 스토리지 용량 제한
- Render 무료 플랜: 100GB 제한
- 대용량 동영상 시 문제 가능

**구현:**
- `/uploads/consultation-videos/YYYY/MM/{consultation_id}/` 구조
- 파일명: `{uuid}.{확장자}` (mp4, mov, avi 등)

#### 옵션 2: 클라우드 스토리지 (S3, Cloudinary 등)
**장점:**
- 무제한 스토리지
- CDN 지원으로 빠른 전송
- 서버 부하 감소

**단점:**
- 추가 비용 발생
- 외부 서비스 의존성
- 구현 복잡도 증가

**권장사항:** 초기에는 **옵션 1 (로컬 저장)**을 사용하고, 필요시 옵션 2로 마이그레이션

---

## 3. 데이터베이스 설계

### 3.1 상담기록 테이블 수정

```sql
-- consultation_records 테이블에 컬럼 추가
ALTER TABLE consultation_records 
ADD COLUMN video_urls TEXT[];  -- 동영상 URL 배열 (PostgreSQL 배열 타입)

-- 또는 JSONB 사용 (더 유연함)
ALTER TABLE consultation_records 
ADD COLUMN video_urls JSONB;  -- [{url: "...", filename: "...", uploaded_at: "..."}]
```

**추천: JSONB 방식**
- 메타데이터 저장 가능 (파일명, 업로드 시간, 파일 크기 등)
- 향후 확장성 좋음

### 3.2 동영상 메타데이터 구조 (JSONB)

```json
[
  {
    "url": "/uploads/consultation-videos/2025/01/{consultation_id}/{uuid}.mp4",
    "filename": "original_filename.mp4",
    "file_size": 10485760,  // bytes
    "mime_type": "video/mp4",
    "uploaded_at": "2025-01-15T10:30:00+09:00",
    "uploaded_by": "trainer_username"
  }
]
```

---

## 4. API 설계

### 4.1 동영상 업로드 API

**POST `/api/consultation-records/:id/videos`**

**Request:**
- Method: `POST`
- Content-Type: `multipart/form-data`
- Body: `file` (동영상 파일)
- Query: `currentUser` (필수)

**Response:**
```json
{
  "video": {
    "url": "/uploads/consultation-videos/2025/01/{consultation_id}/{uuid}.mp4",
    "filename": "original_filename.mp4",
    "file_size": 10485760,
    "mime_type": "video/mp4",
    "uploaded_at": "2025-01-15T10:30:00+09:00"
  }
}
```

**제한사항:**
- 파일 크기: 최대 100MB (설정 가능)
- 허용 형식: mp4, mov, avi, webm
- 권한: admin/su/trainer (본인 작성 상담기록만)

### 4.2 동영상 삭제 API

**DELETE `/api/consultation-records/:id/videos/:videoId`**

**Request:**
- Method: `DELETE`
- Body: `{ currentUser }`
- Params: `id` (상담기록 ID), `videoId` (동영상 UUID)

**Response:**
```json
{
  "message": "동영상이 삭제되었습니다."
}
```

### 4.3 상담기록 조회 시 동영상 포함

기존 API 응답에 `video_urls` 필드가 자동으로 포함됩니다:
- `GET /api/consultation-records/:id`
- `GET /api/public/consultation/:token` (공개 조회)

---

## 5. 프론트엔드 설계

### 5.1 상담기록 입력/수정 모달

**위치:** 기존 상담기록 모달 하단에 "동영상" 섹션 추가

**UI 구성:**
```
┌─ 동영상 ─────────────────────────────┐
│ [동영상 선택] 버튼                    │
│                                      │
│ 업로드된 동영상 목록:                │
│ ┌─────────────────────────────────┐ │
│ │ 📹 video1.mp4 (10MB)      [삭제]│ │
│ │ 📹 video2.mp4 (5MB)       [삭제]│ │
│ └─────────────────────────────────┘ │
└──────────────────────────────────────┘
```

**기능:**
- 파일 선택 버튼 (다중 선택 가능)
- 업로드 진행률 표시
- 업로드된 동영상 목록 표시
- 각 동영상 삭제 버튼
- 파일 크기, 업로드 시간 표시

### 5.2 공개 조회 페이지

**위치:** 상담기록 내용 하단에 "동영상" 섹션 추가

**UI 구성:**
```
┌─ 동영상 ─────────────────────────────┐
│ 📹 동영상 1                          │
│ [비디오 플레이어]                     │
│                                      │
│ 📹 동영상 2                          │
│ [비디오 플레이어]                     │
└──────────────────────────────────────┘
```

**기능:**
- HTML5 `<video>` 태그 사용
- 반응형 비디오 플레이어
- 다중 동영상 지원
- 모바일 최적화

---

## 6. 파일 저장 구조

```
uploads/
  └── consultation-videos/
      └── 2025/
          └── 01/
              └── {consultation_id}/
                  ├── {uuid1}.mp4
                  ├── {uuid2}.mov
                  └── ...
```

**파일명 규칙:**
- UUID 사용 (중복 방지)
- 원본 확장자 유지
- 예: `a1b2c3d4-e5f6-7890-abcd-ef1234567890.mp4`

---

## 7. 보안 고려사항

### 7.1 파일 업로드 보안
- ✅ 파일 타입 검증 (MIME type)
- ✅ 파일 크기 제한 (100MB)
- ✅ 파일명 정규화 (특수문자 제거)
- ✅ 권한 확인 (본인 작성 상담기록만)

### 7.2 파일 접근 보안
- ✅ 공개 조회: 토큰 기반 인증 (기존과 동일)
- ✅ 관리자 조회: 세션 기반 인증
- ✅ 직접 URL 접근 차단 (선택사항)

### 7.3 파일 삭제
- ✅ 상담기록 삭제 시 동영상도 자동 삭제
- ✅ 동영상 개별 삭제 시 파일 시스템에서도 삭제

---

## 8. 구현 단계

### Phase 1: 데이터베이스 및 백엔드
1. ✅ `consultation_records` 테이블에 `video_urls` 컬럼 추가 (마이그레이션)
2. ✅ 동영상 업로드 디렉토리 생성 로직
3. ✅ 동영상 업로드 API 구현
4. ✅ 동영상 삭제 API 구현
5. ✅ 상담기록 조회 시 동영상 포함

### Phase 2: 프론트엔드 (관리자)
1. ✅ 상담기록 모달에 동영상 섹션 추가
2. ✅ 파일 선택 및 업로드 UI
3. ✅ 업로드된 동영상 목록 표시
4. ✅ 동영상 삭제 기능

### Phase 3: 공개 조회 페이지
1. ✅ 동영상 섹션 추가
2. ✅ HTML5 비디오 플레이어 구현
3. ✅ 반응형 디자인 적용

### Phase 4: 테스트 및 최적화
1. ✅ 다양한 동영상 형식 테스트
2. ✅ 대용량 파일 업로드 테스트
3. ✅ 모바일 테스트
4. ✅ 성능 최적화

---

## 9. 파일 크기 및 형식 제한

### 9.1 허용 형식
- **mp4** (H.264 코덱) - 권장
- **mov** (QuickTime)
- **avi**
- **webm**

### 9.2 파일 크기 제한
- **기본**: 100MB
- **설정 가능**: 환경 변수 `CONSULTATION_VIDEO_MAX_SIZE` (bytes)
- **권장**: 50MB 이하 (업로드 속도 고려)

### 9.3 동영상 개수 제한
- **기본**: 상담기록당 최대 5개
- **설정 가능**: 환경 변수 `CONSULTATION_VIDEO_MAX_COUNT`

---

## 10. 에러 처리

### 10.1 업로드 실패 시
- 파일 크기 초과: "파일 크기가 너무 큽니다. (최대 100MB)"
- 지원하지 않는 형식: "지원하지 않는 동영상 형식입니다."
- 권한 없음: "동영상을 업로드할 권한이 없습니다."
- 서버 오류: "동영상 업로드에 실패했습니다."

### 10.2 재시도 로직
- 업로드 실패 시 사용자에게 재시도 옵션 제공
- 부분 업로드 실패 시 롤백 (파일 삭제)

---

## 11. 향후 확장 가능성

### 11.1 동영상 썸네일 생성
- 업로드 시 첫 프레임을 썸네일로 추출
- `ffmpeg` 또는 `fluent-ffmpeg` 사용

### 11.2 동영상 압축
- 업로드 시 자동 압축 (선택사항)
- `ffmpeg` 사용하여 해상도/비트레이트 조정

### 11.3 클라우드 스토리지 마이그레이션
- S3, Cloudinary 등으로 전환 시
- 기존 파일 마이그레이션 스크립트 필요

---

## 12. 성능 고려사항

### 12.1 업로드 최적화
- **청크 업로드**: 대용량 파일을 작은 청크로 나누어 업로드 (선택사항)
- **비동기 처리**: 업로드 중에도 다른 작업 가능

### 12.2 스토리지 관리
- **정기 정리**: 만료된 상담기록의 동영상 자동 삭제 (선택사항)
- **용량 모니터링**: 디스크 사용량 추적

---

## 13. 구현 예시 코드 구조

### 13.1 디렉토리 구조
```
backend/
  ├── consultation-videos-db.js  # 동영상 관련 DB 함수
  └── server.js                  # API 엔드포인트

public/
  ├── js/
  │   └── consultation.js        # 동영상 업로드 UI 로직
  └── consultation-view.html     # 공개 조회 페이지 (동영상 표시)
```

### 13.2 주요 함수
- `uploadConsultationVideo()` - 동영상 업로드
- `deleteConsultationVideo()` - 동영상 삭제
- `getConsultationVideos()` - 동영상 목록 조회
- `formatVideoUrls()` - 동영상 URL 포맷팅

---

## 14. 체크리스트

### 배포 전 확인
- [ ] 데이터베이스 마이그레이션 테스트
- [ ] 파일 업로드/다운로드 테스트
- [ ] 권한 확인 테스트
- [ ] 공개 조회 페이지 동영상 표시 테스트
- [ ] 대용량 파일 업로드 테스트
- [ ] 다양한 브라우저 테스트
- [ ] 모바일 테스트

---

## 15. 참고사항

- **Render 스토리지**: 무료 플랜 100GB 제한
- **동영상 용량**: 평균 10-50MB 가정 시, 약 2,000-10,000개 저장 가능
- **백업**: 정기적인 데이터베이스 백업 필요 (동영상 파일 포함)
