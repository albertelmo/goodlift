# 매출정보 파싱 기능 설계

## 1. 개요

회원정보 파싱 기능과 유사하게, 매출정보 엑셀 파일을 파싱하여 회원 정보와 매출 정보를 매칭하고 필터링할 수 있는 기능을 제공합니다.

## 2. 데이터 구조

### 2.1 엑셀 파일 요구사항

**필수 컬럼:**
- `회원 이름` 또는 `회원이름`: 회원의 이름
- `연락처`: 회원의 연락처 (전화번호)
- `매출 이름` 또는 `매출이름`: 매출 항목 이름 (예: "PT 10회", "식단 프로그램" 등)

**옵션 컬럼:**
- `매출 금액`: 매출 금액 (추후 확장 가능)
- `매출 일자`: 매출 발생 일자 (추후 확장 가능)

### 2.2 파싱 결과 데이터 구조

```javascript
{
  sales: [
    {
      memberName: "홍길동",
      phone: "010-1234-5678",
      salesNames: ["PT 10회", "식단 프로그램"],  // 배열 (여러 매출 가능)
      // 추후 확장 가능:
      // totalAmount: 500000,
      // salesDates: ["2024-01-15", "2024-01-20"]
    },
    ...
  ],
  total: 150,  // 전체 매출 건수
  allSalesNames: ["PT 10회", "식단 프로그램", "요가 클래스", ...]  // 모든 매출 이름 목록 (중복 제거, 정렬)
}
```

## 3. 백엔드 설계

### 3.1 API 엔드포인트

**POST `/api/database/parse-sales-excel`**
- 파일 업로드 및 파싱 처리
- 회원정보 파싱 API와 유사한 구조

### 3.2 파싱 로직

1. **엑셀 파일 읽기**
   - ExcelJS를 사용하여 엑셀 파일 읽기
   - 첫 번째 시트 사용
   - 빈 셀 처리 (null로 채우기)

2. **헤더 확인 및 컬럼 찾기**
   - 헤더 정규화: 띄어쓰기 제거 후 비교
   - 필수 컬럼 찾기:
     - `회원 이름` / `회원이름`
     - `연락처`
     - `매출 이름` / `매출이름`

3. **데이터 파싱**
   - 회원 이름 + 연락처를 키로 사용하여 매출 정보 그룹화
   - 같은 회원(이름+연락처)에 여러 매출이 있는 경우, 매출 이름들을 배열로 수집
   - 회원별로 여러 행에 걸쳐 매출 정보가 있을 수 있으므로, 동일 회원의 매출들을 합침

4. **매출 이름 목록 수집**
   - 모든 매출 이름을 수집하여 중복 제거 및 정렬
   - 프론트엔드 필터링 UI 생성에 사용

### 3.3 에러 처리

- 필수 컬럼 누락 시 에러 메시지 반환
- 파일 형식 오류 처리
- 빈 데이터 처리

## 4. 프론트엔드 설계

### 4.1 UI 구조

매출정보 파싱 결과를 표시하기 위한 새로운 섹션 추가:

1. **매출 이름 선택 영역** (회원정보의 "상품명 선택"과 유사)
   - 체크박스 리스트로 매출 이름 표시
   - 전체 선택/해제 버튼
   - 필터 적용 버튼

2. **매출 정보 테이블**
   - 회원 이름
   - 연락처
   - 매출 이름 (배열, 쉼표로 구분)
   - 정렬 기능 (회원 이름, 연락처 기준)

3. **액션 버튼**
   - 엑셀 다운로드
   - (추후) DB 저장 기능 (선택사항)

### 4.2 데이터 흐름

1. **파일 업로드**
   - 사용자가 매출정보 엑셀 파일 업로드
   - `/api/database/parse-sales-excel` API 호출

2. **파싱 결과 처리**
   - `window.databaseAllSales`에 전체 매출 데이터 저장
   - `window.databaseAllSalesNames`에 전체 매출 이름 목록 저장
   - 매출 이름 선택 UI 생성 (`displaySalesNameSelectors` 함수)

3. **필터링**
   - 선택된 매출 이름에 따라 필터링
   - 필터링된 결과를 `window.databaseFilteredSales`에 저장
   - 테이블 업데이트 (`displaySales` 함수)

### 4.3 함수 구조

**회원정보와 유사한 패턴:**

```javascript
// 매출 이름 선택 UI 생성
function displaySalesNameSelectors(salesNames) {
  // 체크박스 생성 로직
}

// 매출 정보 테이블 표시
function displaySales(sales, selectedSalesNames = []) {
  // 필터링 로직
  // 테이블 렌더링
}

// 필터링 설정
function setupSalesFiltering() {
  // 필터 적용 버튼 이벤트
  // 전체 선택/해제 버튼 이벤트
}
```

## 5. 구현 순서

1. **백엔드 API 구현**
   - `/api/database/parse-sales-excel` 엔드포인트 추가
   - 엑셀 파싱 로직 구현
   - 필수 컬럼 검증
   - 데이터 구조화 및 반환

2. **프론트엔드 기본 구조**
   - 매출정보 섹션 HTML 추가
   - 파일 업로드 이벤트 리스너 수정 (기존 `database-sales-upload-form`)

3. **UI 컴포넌트 구현**
   - 매출 이름 선택 영역
   - 매출 정보 테이블
   - 필터링 기능

4. **통합 및 테스트**
   - 회원정보와 매출정보 동시 표시 테스트
   - 필터링 기능 테스트

## 6. 데이터 매칭 전략

### 6.1 회원 매칭

- **키**: `회원 이름` + `연락처` 조합
- 같은 이름과 연락처를 가진 행들은 같은 회원으로 처리
- 회원별로 매출 이름들을 배열로 수집

### 6.2 매출 이름 정규화

- 매출 이름은 "매출 이름" 컬럼에서 직접 추출
- 중복 제거 및 정렬 (한글 가나다순 또는 알파벳순)

## 7. 확장 가능성

향후 확장 가능한 기능:

1. **매출 금액 집계**
   - 회원별 매출 합계
   - 매출 이름별 매출 합계

2. **DB 저장 기능**
   - 매출정보 스냅샷 저장
   - 회원정보와 연동하여 조회

3. **매출 분석**
   - 기간별 매출 분석
   - 매출 이름별 인기 순위

4. **회원정보와 매칭**
   - 파싱된 회원정보와 매출정보를 이름/연락처로 자동 매칭
   - 통합 대시보드 표시

## 8. 주의사항

1. **회원정보 파싱과 독립적**
   - 매출정보 파싱은 회원정보 파싱과 별도로 동작
   - 동일한 회원이 회원정보와 매출정보에 모두 있을 수 있음

2. **데이터 무결성**
   - 회원 이름과 연락처가 정확히 일치해야 같은 회원으로 인식
   - 공백, 하이픈 등 형식 차이에 주의

3. **성능**
   - 대용량 파일 처리 시 성능 고려
   - 클라이언트 측 필터링은 적절한 수준의 데이터만 처리
