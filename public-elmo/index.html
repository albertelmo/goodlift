<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Elmo ì„œë¹„ìŠ¤">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Elmo</title>
    <link rel="manifest" href="/elmo/manifest.json">
    <link rel="stylesheet" href="/elmo/css/elmo.css">
    <meta name="theme-color" content="#1976d2">
</head>
<body>
    <!-- PWA ì—…ë°ì´íŠ¸ ì•Œë¦¼ ë°°ë„ˆ -->
    <div id="pwa-update-banner" style="display:none;position:fixed;top:0;left:0;right:0;z-index:999999;background:#2196F3;color:#fff;padding:12px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.2);animation:slideDown 0.3s ease-out;">
        <div style="max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
            <div style="display:flex;align-items:center;gap:8px;">
                <span style="font-size:18px;">âœ¨</span>
                <span style="font-weight:500;font-size:14px;">ìƒˆ ë²„ì „ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</span>
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
                <button id="pwa-update-btn" style="background:#fff;color:#2196F3;border:none;padding:6px 16px;border-radius:4px;font-weight:600;font-size:13px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='#fff'">
                    ì§€ê¸ˆ ì—…ë°ì´íŠ¸
                </button>
                <button id="pwa-update-close" style="background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.5);padding:6px 12px;border-radius:4px;font-size:13px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='#fff'" onmouseout="this.style.borderColor='rgba(255,255,255,0.5)'">
                    ë‚˜ì¤‘ì—
                </button>
            </div>
        </div>
    </div>
    <style>
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        /* ë°°ë„ˆê°€ í‘œì‹œë  ë•Œ ì½˜í…ì¸ ë¥¼ ì•„ë˜ë¡œ ë°€ê¸° */
        body.pwa-banner-visible {
            padding-top: 48px;
        }
        @media (max-width: 600px) {
            body.pwa-banner-visible {
                padding-top: 68px;
            }
        }
        /* ì—˜ëª¨ í—¤ë”ê°€ ë°°ë„ˆë¥¼ ë®ì§€ ì•Šë„ë¡ */
        body.pwa-banner-visible .elmo-header {
            top: 52px; /* ë°°ë„ˆ ë†’ì´ë§Œí¼ë§Œ */
        }
        /* ì—˜ëª¨ ë©”ì¸ ì„¹ì…˜ë„ ë°°ë„ˆ ê³µê°„ í™•ë³´ */
        body.pwa-banner-visible #elmo-main-section {
            padding-top: 48px;
        }
        @media (max-width: 600px) {
            body.pwa-banner-visible #elmo-main-section {
                padding-top: 68px;
            }
        }
    </style>

    <!-- íšŒì›ê°€ì… ëª¨ë‹¬ (body ì§í•˜ìœ„ë¡œ ì´ë™í•˜ì—¬ overflow ë¬¸ì œ ë°©ì§€) -->
    <div id="elmo-register-modal" style="display:none;">
        <div class="elmo-modal-content">
            <div class="elmo-modal-header">
                <h2>íšŒì›ê°€ì…</h2>
                <button type="button" id="elmo-register-close" class="elmo-modal-close">&times;</button>
            </div>
            <form id="elmo-register-form" class="elmo-form">
                <div class="elmo-form-group">
                    <label for="elmo-register-username">ì•„ì´ë””</label>
                    <input type="text" id="elmo-register-username" name="username" required autocomplete="username">
                </div>
                <div class="elmo-form-group">
                    <label for="elmo-register-password">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="elmo-register-password" name="password" required autocomplete="new-password">
                </div>
                <div class="elmo-form-group">
                    <label for="elmo-register-name">ì´ë¦„</label>
                    <input type="text" id="elmo-register-name" name="name" required>
                </div>
                <div class="elmo-form-group">
                    <label for="elmo-register-email">ì´ë©”ì¼ (ì„ íƒ)</label>
                    <input type="email" id="elmo-register-email" name="email" autocomplete="email">
                </div>
                <div id="elmo-register-result" class="elmo-result"></div>
                <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
                    <button type="button" id="elmo-register-cancel" class="elmo-btn elmo-btn-secondary">ì·¨ì†Œ</button>
                    <button type="submit" class="elmo-btn elmo-btn-primary">ê°€ì…í•˜ê¸°</button>
                </div>
            </form>
        </div>
    </div>

    <div id="elmo-app">
        <!-- ë¡œê·¸ì¸ í™”ë©´ -->
        <div id="elmo-login-section" class="elmo-section">
            <div class="elmo-login-container">
                <div class="elmo-logo">
                    <h1>Elmo</h1>
                </div>
                <form id="elmo-login-form" class="elmo-form">
                    <div class="elmo-form-group">
                        <label for="elmo-username">ì•„ì´ë””</label>
                        <input type="text" id="elmo-username" name="username" required autocomplete="username">
                    </div>
                    <div class="elmo-form-group">
                        <label for="elmo-password">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="elmo-password" name="password" required autocomplete="current-password">
                    </div>
                    <div id="elmo-login-result" class="elmo-result"></div>
                    <button type="submit" class="elmo-btn elmo-btn-primary">ë¡œê·¸ì¸</button>
                </form>
                <button type="button" id="elmo-register-btn" class="elmo-btn elmo-btn-text" style="margin-top: 8px; width: 100%;">íšŒì›ê°€ì…</button>
            </div>
        </div>

        <!-- íšŒì›ê°€ì… ë²„íŠ¼ ì¸ë¼ì¸ ì´ë²¤íŠ¸ ë°”ì¸ë”© (ì¦‰ì‹œ ì‹¤í–‰) -->
        <script>
            (function() {
                function setupRegisterButton() {
                    const btn = document.getElementById('elmo-register-btn');
                    if (btn) {
                        // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ì¬ë“±ë¡
                        const newBtn = btn.cloneNode(true);
                        btn.parentNode.replaceChild(newBtn, btn);
                        const registerBtn = document.getElementById('elmo-register-btn');
                        registerBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            const modal = document.getElementById('elmo-register-modal');
                            if (modal) {
                                // ëª¨ë‹¬ì´ body ì§í•˜ìœ„ì— ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ì´ë™
                                if (modal.parentElement !== document.body) {
                                    document.body.appendChild(modal);
                                }
                                
                                // ëª¨ë‹¬ í‘œì‹œ - position: fixedì™€ flex ì •ë ¬ì´ ì œëŒ€ë¡œ ì ìš©ë˜ë„ë¡ ëª…ì‹œ
                                modal.style.display = 'flex';
                                modal.style.flexDirection = 'row';
                                modal.style.justifyContent = 'center';
                                modal.style.alignItems = 'center';
                                modal.style.position = 'fixed';
                                modal.style.top = '0';
                                modal.style.left = '0';
                                modal.style.right = '0';
                                modal.style.bottom = '0';
                                modal.style.width = '100vw';
                                modal.style.height = '100vh';
                                modal.style.zIndex = '10000';
                                modal.style.background = '#f5f5f5';
                                modal.style.margin = '0';
                                modal.style.padding = '24px';
                                modal.style.boxSizing = 'border-box';
                                
                                const form = document.getElementById('elmo-register-form');
                                const resultDiv = document.getElementById('elmo-register-result');
                                if (form) form.reset();
                                if (resultDiv) {
                                    resultDiv.textContent = '';
                                    resultDiv.className = 'elmo-result';
                                }
                            }
                        });
                    } else {
                        setTimeout(setupRegisterButton, 100);
                    }
                }
                // ì¦‰ì‹œ ì‹¤í–‰
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', setupRegisterButton);
                } else {
                    setupRegisterButton();
                }
                // ì¶”ê°€ ì•ˆì „ì¥ì¹˜
                window.addEventListener('load', setupRegisterButton);
            })();
        </script>

        <!-- ë©”ì¸ í™”ë©´ -->
        <div id="elmo-main-section" class="elmo-section" style="display:none;">
            <!-- í—¤ë” -->
            <header class="elmo-header">
                <button class="elmo-hamburger-btn" id="elmo-hamburger-btn">â˜°</button>
                <h1 class="elmo-header-title">Elmo</h1>
            </header>

            <!-- ì‚¬ì´ë“œ ë“œë¡œì–´ -->
            <div id="elmo-drawer" class="elmo-drawer">
                <div class="elmo-drawer-header">
                    <h2>ë©”ë‰´</h2>
                    <button class="elmo-drawer-close" id="elmo-drawer-close">&times;</button>
                </div>
                <div class="elmo-drawer-content">
                    <div class="elmo-drawer-user">
                        <div class="elmo-drawer-avatar" id="elmo-drawer-avatar">U</div>
                        <div class="elmo-drawer-user-info">
                            <div class="elmo-drawer-user-name" id="elmo-drawer-user-name">ì‚¬ìš©ì</div>
                            <div class="elmo-drawer-user-id" id="elmo-drawer-user-id">username</div>
                        </div>
                    </div>
                    <div class="elmo-drawer-menu">
                        <a href="#" class="elmo-drawer-item" data-screen="home">
                            <span class="elmo-drawer-item-icon">ğŸ </span>
                            <span class="elmo-drawer-item-label">í™ˆ</span>
                        </a>
                        <a href="#" class="elmo-drawer-item" data-screen="calendar">
                            <span class="elmo-drawer-item-icon">ğŸ“…</span>
                            <span class="elmo-drawer-item-label">ìº˜ë¦°ë”</span>
                        </a>
                        <a href="#" class="elmo-drawer-item" data-screen="goodlift">
                            <span class="elmo-drawer-item-icon">ğŸ’ª</span>
                            <span class="elmo-drawer-item-label">êµ¿ë¦¬í”„íŠ¸</span>
                        </a>
                        <a href="#" class="elmo-drawer-item" data-screen="profile">
                            <span class="elmo-drawer-item-icon">ğŸ‘¤</span>
                            <span class="elmo-drawer-item-label">ë‚´ì •ë³´</span>
                        </a>
                    </div>
                    <div class="elmo-drawer-footer">
                        <a href="#" class="elmo-drawer-item" id="elmo-drawer-account-management" data-screen="account-management" style="display: none;">
                            <span class="elmo-drawer-item-icon">âš™ï¸</span>
                            <span class="elmo-drawer-item-label">ê³„ì •ê´€ë¦¬</span>
                        </a>
                        <button class="elmo-drawer-item elmo-drawer-item-logout" id="elmo-drawer-logout">
                            <span class="elmo-drawer-item-icon">ğŸšª</span>
                            <span class="elmo-drawer-item-label">ë¡œê·¸ì•„ì›ƒ</span>
                        </button>
                    </div>
                </div>
            </div>
            <div id="elmo-drawer-overlay" class="elmo-drawer-overlay" style="display:none;"></div>

            <!-- ë©”ì¸ ì½˜í…ì¸  -->
            <main class="elmo-content" id="elmo-content"></main>

            <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
            <nav class="elmo-bottom-nav">
                <a href="#" class="elmo-bottom-nav-item active" data-screen="home">
                    <span class="elmo-bottom-nav-icon">ğŸ </span>
                    <span class="elmo-bottom-nav-label">í™ˆ</span>
                </a>
                <a href="#" class="elmo-bottom-nav-item" data-screen="calendar">
                    <span class="elmo-bottom-nav-icon">ğŸ“…</span>
                    <span class="elmo-bottom-nav-label">ìº˜ë¦°ë”</span>
                </a>
                <a href="#" class="elmo-bottom-nav-item" data-screen="goodlift">
                    <span class="elmo-bottom-nav-icon">ğŸ’ª</span>
                    <span class="elmo-bottom-nav-label">êµ¿ë¦¬í”„íŠ¸</span>
                </a>
                <a href="#" class="elmo-bottom-nav-item" data-screen="profile">
                    <span class="elmo-bottom-nav-icon">ğŸ‘¤</span>
                    <span class="elmo-bottom-nav-label">ë‚´ì •ë³´</span>
                </a>
            </nav>
        </div>
    </div>

    <script type="module" src="/elmo/js/elmo-main.js"></script>
    
    <script>
        // PWA ì—…ë°ì´íŠ¸ ì‹œìŠ¤í…œ (í™˜ê²½ ìƒê´€ì—†ì´ í´ë§ ë°©ì‹)
        (function() {
            let currentVersion = null;
            let newWorker = null;
            let latestDetectedVersion = null;
            let dismissedUntil = 0; // "ë‚˜ì¤‘ì—" í´ë¦­ ì‹œ ë‹¤ì‹œ ì•Œë¦¼ í‘œì‹œ ì‹œê°„

            
            // Service Worker ë“±ë¡ (HTTPS í”„ë¡œë•ì…˜ìš©)
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/elmo/sw.js')
                        .then((registration) => {
                            console.log('[Elmo PWA] Service Worker ë“±ë¡ ì„±ê³µ');
                            
                            // ì—…ë°ì´íŠ¸ ê°ì§€
                            registration.addEventListener('updatefound', () => {
                                const installing = registration.installing;
                                installing.addEventListener('statechange', () => {
                                    if (installing.state === 'installed' && navigator.serviceWorker.controller) {
                                        newWorker = installing;
                                        fetch('/api/pwa/version')
                                            .then(res => res.json())
                                            .then(data => {
                                                latestDetectedVersion = data.version;
                                            })
                                            .catch(() => {});
                                        showUpdateBanner();
                                    }
                                });
                            });
                        })
                        .catch((error) => {
                            console.error('[Elmo PWA] Service Worker ë“±ë¡ ì‹¤íŒ¨:', error);
                        });
                });
                
                // Controller ë³€ê²½ ì‹œ ìƒˆë¡œê³ ì¹¨
                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (!refreshing) {
                        refreshing = true;
                        window.location.reload();
                    }
                });
            }

            
            // ì´ˆê¸° ë²„ì „ ë¡œë“œ
            fetch('/api/pwa/version')
                .then(res => res.json())
                .then(data => {
                    currentVersion = data.version;
                    console.log('[Elmo PWA] í˜„ì¬ ë²„ì „:', currentVersion);
                })
                .catch(() => {});
            
            // 30ì´ˆë§ˆë‹¤ ë²„ì „ ì²´í¬ (ëª¨ë“  í™˜ê²½ì—ì„œ ë™ì‘)
            setInterval(() => {
                if (!currentVersion) return;
                
                fetch('/api/pwa/version?t=' + Date.now())
                    .then(res => res.json())
                    .then(data => {
                        if (data.version !== currentVersion) {
                            latestDetectedVersion = data.version;
                            console.log('[Elmo PWA] ìƒˆ ë²„ì „ ë°œê²¬:', currentVersion, 'â†’', data.version);
                            showUpdateBanner();
                        }
                    })
                    .catch(() => {});
            }, 30000); // 30ì´ˆ
            
            // ì—…ë°ì´íŠ¸ ë°°ë„ˆ í‘œì‹œ
            function showUpdateBanner() {
                // "ë‚˜ì¤‘ì—" í´ë¦­ í›„ 1ì‹œê°„ì´ ì§€ë‚˜ì§€ ì•Šì•˜ìœ¼ë©´ í‘œì‹œ ì•ˆ í•¨
                if (Date.now() < dismissedUntil) {
                    return;
                }
                
                const banner = document.getElementById('pwa-update-banner');
                const updateBtn = document.getElementById('pwa-update-btn');
                const closeBtn = document.getElementById('pwa-update-close');
                
                if (banner && banner.style.display === 'none') {
                    banner.style.display = 'block';
                    document.body.classList.add('pwa-banner-visible');
                    
                    updateBtn.onclick = () => {
                        if (latestDetectedVersion) {
                            currentVersion = latestDetectedVersion;
                        }
                        if (newWorker) {
                            // Service Worker ìˆìœ¼ë©´ ì¦‰ì‹œ í™œì„±í™”
                            newWorker.postMessage({ type: 'SKIP_WAITING' });
                        } else {
                            // ì—†ìœ¼ë©´ ê°•ì œ ìƒˆë¡œê³ ì¹¨
                            window.location.reload(true);
                        }
                    };
                    
                    closeBtn.onclick = () => {
                        banner.style.display = 'none';
                        document.body.classList.remove('pwa-banner-visible');
                        // 1ì‹œê°„ í›„ ë‹¤ì‹œ ì•Œë¦¼
                        dismissedUntil = Date.now() + (60 * 60 * 1000);
                        console.log('[Elmo PWA] 1ì‹œê°„ í›„ ë‹¤ì‹œ ì•Œë¦¼ ì˜ˆì •');
                    };
                }
            }
        })();
    </script>
</body>
</html>
